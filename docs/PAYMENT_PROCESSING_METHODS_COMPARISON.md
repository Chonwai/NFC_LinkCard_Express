# æ”¯ä»˜æˆåŠŸè™•ç†æ–¹æ³•æ¯”è¼ƒæŒ‡å—
*æ¥­ç•Œæœ€ä½³å¯¦è¸åˆ†æ*

## ğŸ¤” **ç”¨æˆ¶ç–‘å•**
> "æ‰€ä»¥æ­£ç¢ºçš„åšæ³•æ˜¯è¦ Webhookï¼Ÿæ˜¯ä¸æ˜¯æ²’æœ‰å…¶ä»–æ–¹æ³•äº†ï¼Ÿæ¥­ç•Œçš„åšæ³•æœƒæ˜¯ï¼Ÿ"

## ğŸ“Š **æ”¯ä»˜æˆåŠŸè™•ç†çš„æ‰€æœ‰æ–¹æ³•**

### æ–¹æ³• 1: **Webhook**ï¼ˆâœ… æ¥­ç•Œæ¨è–¦ï¼‰

#### å·¥ä½œåŸç†
```
ç”¨æˆ¶æ”¯ä»˜ â†’ Stripe è™•ç† â†’ Stripe ä¸»å‹•ç™¼é€äº‹ä»¶åˆ°ä½ çš„æœå‹™å™¨ â†’ è‡ªå‹•è™•ç†
```

#### å„ªé»
- âœ… **å¯¦æ™‚æ€§**ï¼šæ”¯ä»˜æˆåŠŸç«‹å³é€šçŸ¥ï¼Œå»¶é² < 1 ç§’
- âœ… **å¯é æ€§**ï¼šStripe æœƒé‡è©¦å¤±æ•—çš„è«‹æ±‚
- âœ… **å®‰å…¨æ€§**ï¼šç°½åé©—è­‰ç¢ºä¿è«‹æ±‚ä¾†è‡ª Stripe
- âœ… **ç¯€çœè³‡æº**ï¼šä¸éœ€è¦è¼ªè©¢ï¼Œç¯€çœ API èª¿ç”¨
- âœ… **å®˜æ–¹æ¨è–¦**ï¼šStripe å®˜æ–¹å¼·çƒˆæ¨è–¦çš„æ–¹æ³•

#### ç¼ºé»
- âŒ **é…ç½®è¤‡é›œ**ï¼šéœ€è¦è¨­ç½® HTTPS ç«¯é»å’Œç°½åé©—è­‰
- âŒ **ç¶²çµ¡ä¾è³´**ï¼šå¦‚æœæœå‹™å™¨ç„¡æ³•è¨ªå•æœƒå¤±æ•—

#### æ¥­ç•Œä½¿ç”¨ç‡
**95%+ çš„å¤§å‹é›»å•†å’Œ SaaS å…¬å¸ä½¿ç”¨ Webhook**

---

### æ–¹æ³• 2: **è¼ªè©¢ï¼ˆPollingï¼‰**

#### å·¥ä½œåŸç†
```
ç”¨æˆ¶æ”¯ä»˜ â†’ å®šæœŸæª¢æŸ¥æ”¯ä»˜ç‹€æ…‹ â†’ ç™¼ç¾ç‹€æ…‹è®ŠåŒ– â†’ è™•ç†
```

#### ä»£ç¢¼ç¤ºä¾‹
```typescript
// æ¯ 30 ç§’æª¢æŸ¥ä¸€æ¬¡æ”¯ä»˜ç‹€æ…‹
setInterval(async () => {
  const pendingOrders = await prisma.purchaseOrder.findMany({
    where: { status: 'PENDING' }
  });
  
  for (const order of pendingOrders) {
    const session = await stripe.checkout.sessions.retrieve(order.stripeSessionId);
    if (session.payment_status === 'paid') {
      await handlePaymentSuccess(order.id, session);
    }
  }
}, 30000);
```

#### å„ªé»
- âœ… **ç°¡å–®å¯¦ç¾**ï¼šä¸éœ€è¦é…ç½®å¤–éƒ¨ç«¯é»
- âœ… **å®¹æ˜“èª¿è©¦**ï¼šå¯ä»¥æ‰‹å‹•æ§åˆ¶æª¢æŸ¥æ™‚æ©Ÿ
- âœ… **é©åˆé–‹ç™¼**ï¼šé–‹ç™¼ç’°å¢ƒä¸­å®¹æ˜“æ¸¬è©¦

#### ç¼ºé»
- âŒ **å»¶é²é«˜**ï¼šæœ€å¤šå»¶é²è¼ªè©¢é–“éš”æ™‚é–“
- âŒ **è³‡æºæµªè²»**ï¼šæŒçºŒçš„ API èª¿ç”¨æ¶ˆè€—é…é¡
- âŒ **é€Ÿç‡é™åˆ¶**ï¼šStripe é™åˆ¶ API èª¿ç”¨é »ç‡
- âŒ **æ“´å±•æ€§å·®**ï¼šè¨‚å–®å¤šäº†æœƒå½±éŸ¿æ€§èƒ½

---

### æ–¹æ³• 3: **å‰ç«¯å›èª¿**ï¼ˆâŒ ä¸å®‰å…¨ï¼‰

#### å·¥ä½œåŸç†
```
ç”¨æˆ¶æ”¯ä»˜ â†’ Stripe é‡å®šå‘åˆ°æˆåŠŸé é¢ â†’ å‰ç«¯èª¿ç”¨å¾Œç«¯ API â†’ è™•ç†
```

#### å„ªé»
- âœ… **å¯¦ç¾ç°¡å–®**ï¼šå‰ç«¯ç›´æ¥è™•ç†
- âœ… **ç”¨æˆ¶é«”é©—å¥½**ï¼šç«‹å³é¡¯ç¤ºæˆåŠŸç‹€æ…‹

#### ç¼ºé»
- âŒ **æ¥µä¸å®‰å…¨**ï¼šç”¨æˆ¶å¯ä»¥å½é€ æˆåŠŸè«‹æ±‚
- âŒ **ä¸å¯é **ï¼šç”¨æˆ¶é—œé–‰ç€è¦½å™¨æœƒä¸Ÿå¤±
- âŒ **æ¥­ç•Œç¦ç”¨**ï¼šæ²’æœ‰åš´è‚…çš„æ”¯ä»˜ç³»çµ±æœƒç”¨é€™ç¨®æ–¹æ³•

---

### æ–¹æ³• 4: **æ··åˆæ–¹æ³•**ï¼ˆğŸ”„ æ¨è–¦ï¼‰

#### å·¥ä½œåŸç†
```
ä¸»è¦ï¼šWebhook è™•ç†æ”¯ä»˜æˆåŠŸ
å‚™ç”¨ï¼šè¼ªè©¢è™•ç† Webhook å¤±æ•—çš„æƒ…æ³
å‰ç«¯ï¼šåƒ…ç”¨æ–¼ç”¨æˆ¶é«”é©—ï¼Œä¸è™•ç†æ¥­å‹™é‚è¼¯
```

#### å¯¦ç¾ç­–ç•¥
```typescript
// 1. Webhook è™•ç†ï¼ˆä¸»è¦ï¼‰
app.post('/webhook', handleStripeWebhook);

// 2. å®šæœŸè¼ªè©¢æª¢æŸ¥éºæ¼ï¼ˆå‚™ç”¨ï¼‰
cron.schedule('*/5 * * * *', async () => {
  await checkMissedPayments();
});

// 3. å‰ç«¯æŸ¥è©¢ç‹€æ…‹ï¼ˆç”¨æˆ¶é«”é©—ï¼‰
app.get('/payment/status/:sessionId', getPaymentStatus);
```

---

## ğŸ† **æ¥­ç•Œæœ€ä½³å¯¦è¸**

### **å¤§å‹å…¬å¸çš„åšæ³•**

| å…¬å¸ | ä¸»è¦æ–¹æ³• | å‚™ç”¨æ–¹æ³• | èªªæ˜ |
|------|---------|---------|------|
| Shopify | Webhook | è¼ªè©¢ | Webhook ç‚ºä¸»ï¼Œ5åˆ†é˜è¼ªè©¢æª¢æŸ¥éºæ¼ |
| Spotify | Webhook | æ‰‹å‹•é‡è©¦ | Webhook + ç®¡ç†å“¡å·¥å…·æ‰‹å‹•é‡è©¦ |
| Netflix | Webhook | å¯¦æ™‚æŸ¥è©¢ | Webhook + ç”¨æˆ¶æŸ¥è©¢æ™‚å¯¦æ™‚æª¢æŸ¥ |
| Uber | Webhook | è¼ªè©¢ + å‘Šè­¦ | å¤šé‡ä¿éšœ + å¤±æ•—å‘Šè­¦ |

### **Stripe å®˜æ–¹å»ºè­°**

æ ¹æ“š Stripe å®˜æ–¹æ–‡æª”ï¼š

1. **âœ… æ¨è–¦ï¼šWebhook**
   > "Webhooks æ˜¯è™•ç†ç•°æ­¥äº‹ä»¶ï¼ˆå¦‚æ”¯ä»˜ç¢ºèªï¼‰çš„æ¨è–¦æ–¹å¼"

2. **âš ï¸ è¬¹æ…ï¼šè¼ªè©¢**
   > "Stripe å° API è«‹æ±‚å¯¦æ–½é€Ÿç‡é™åˆ¶ï¼Œå¦‚æœä½¿ç”¨è¼ªè©¢è«‹è¬¹æ…"

3. **âŒ ä¸æ¨è–¦ï¼šåƒ…ä¾è³´å‰ç«¯**
   > "æ°¸é ä¸è¦åƒ…ä¾è³´å‰ç«¯å›èª¿ä¾†ç¢ºèªæ”¯ä»˜"

---

## ğŸ”§ **æˆ‘å€‘é …ç›®çš„å»ºè­°æ–¹æ¡ˆ**

### **çŸ­æœŸè§£æ±ºæ–¹æ¡ˆ**ï¼ˆç«‹å³å¯ç”¨ï¼‰

#### é¸é … 1: å¿«é€Ÿ Webhook é…ç½®
```bash
# ä½¿ç”¨ ngrok æš´éœ²æœ¬åœ°æœå‹™å™¨
npx ngrok http 3020

# åœ¨ Stripe Dashboard é…ç½® Webhook
URL: https://abc123.ngrok.io/api/payment/purchase-orders/webhook
Events: checkout.session.completed

# è¤‡è£½ Webhook å¯†é‘°åˆ° .env
STRIPE_WEBHOOK_SECRET=whsec_real_secret_here
```

#### é¸é … 2: æ·»åŠ è¼ªè©¢å‚™ç”¨æ©Ÿåˆ¶
```typescript
// æ·»åŠ åˆ° PurchaseOrderService
async checkPendingOrders() {
  const pendingOrders = await this.prisma.purchaseOrder.findMany({
    where: { 
      status: 'PENDING',
      createdAt: { gte: new Date(Date.now() - 24 * 60 * 60 * 1000) } // 24å°æ™‚å…§
    }
  });
  
  for (const order of pendingOrders) {
    try {
      const session = await this.stripe.checkout.sessions.retrieve(
        order.stripeData.sessionId
      );
      
      if (session.payment_status === 'paid' && order.status !== 'PAID') {
        await this.handlePaymentSuccess(order.id, {
          sessionId: session.id,
          paymentStatus: 'paid'
        });
      }
    } catch (error) {
      console.error(`æª¢æŸ¥è¨‚å–® ${order.id} å¤±æ•—:`, error);
    }
  }
}
```

### **é•·æœŸå»ºè­°**ï¼ˆç”Ÿç”¢ç’°å¢ƒï¼‰

```typescript
// æ··åˆæ–¹æ¡ˆï¼šWebhook + è¼ªè©¢ + ç”¨æˆ¶æŸ¥è©¢
class PaymentProcessor {
  // ä¸»è¦æ–¹æ³•ï¼šWebhook
  async handleWebhook(payload, signature) {
    // ç¾æœ‰çš„ Webhook è™•ç†é‚è¼¯
  }
  
  // å‚™ç”¨æ–¹æ³•ï¼šå®šæœŸè¼ªè©¢æª¢æŸ¥éºæ¼
  @Cron('*/5 * * * *') // æ¯5åˆ†é˜
  async checkMissedPayments() {
    // æª¢æŸ¥å¯èƒ½éºæ¼çš„æ”¯ä»˜
  }
  
  // ç”¨æˆ¶æŸ¥è©¢ï¼šå¯¦æ™‚ç‹€æ…‹æª¢æŸ¥
  async getPaymentStatus(sessionId: string) {
    // æŸ¥è©¢æ•¸æ“šåº« + å¿…è¦æ™‚æŸ¥è©¢ Stripe
  }
}
```

---

## ğŸ“Š **æ€§èƒ½å°æ¯”**

| æ–¹æ³• | å¯¦æ™‚æ€§ | å¯é æ€§ | è³‡æºæ¶ˆè€— | é–‹ç™¼è¤‡é›œåº¦ | é©ç”¨å ´æ™¯ |
|------|--------|--------|----------|------------|----------|
| Webhook | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­ | ç”Ÿç”¢ç’°å¢ƒ |
| è¼ªè©¢ | â­â­â­ | â­â­â­â­ | â­â­ | â­â­â­â­â­ | é–‹ç™¼/å‚™ç”¨ |
| å‰ç«¯å›èª¿ | â­â­â­â­â­ | â­ | â­â­â­â­â­ | â­â­â­â­â­ | åƒ…ç”¨æˆ¶é«”é©— |
| æ··åˆæ–¹æ¡ˆ | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­ | â­â­ | ä¼æ¥­ç´š |

---

## ğŸš€ **ç«‹å³è¡Œå‹•æ–¹æ¡ˆ**

### **ä»Šå¤©å°±å¯ä»¥è§£æ±º**ï¼ˆé¸ä¸€å€‹ï¼‰

1. **æ–¹æ¡ˆ Aï¼š5åˆ†é˜ Webhook é…ç½®**
   ```bash
   # ä½¿ç”¨ ngrok æˆ– Stripe CLI
   stripe listen --forward-to localhost:3020/api/payment/purchase-orders/webhook
   ```

2. **æ–¹æ¡ˆ Bï¼šæ·»åŠ è¼ªè©¢æ©Ÿåˆ¶**
   ```bash
   # é‹è¡Œæˆ‘å€‘å‰µå»ºçš„æ¸¬è©¦è…³æœ¬é©—è­‰é‚è¼¯æ­£å¸¸
   node test-payment-success.js
   
   # ç„¶å¾Œæ·»åŠ å®šæœŸè¼ªè©¢ä»£ç¢¼
   ```

3. **æ–¹æ¡ˆ Cï¼šæ‰‹å‹•è™•ç†ç¾æœ‰æ”¯ä»˜**
   ```bash
   # å°æ–¼å·²ç¶“æ”¯ä»˜ä½†æœªå‰µå»ºæœƒå“¡çš„æƒ…æ³
   # å¯ä»¥æ‰‹å‹•é‹è¡Œæ¸¬è©¦è…³æœ¬ä¾†ä¿®å¾©
   ```

---

## ğŸ’¡ **æœ€çµ‚ç­”æ¡ˆ**

### **æ˜¯å¦å¿…é ˆç”¨ Webhookï¼Ÿ**
- **ç”Ÿç”¢ç’°å¢ƒï¼šæ˜¯çš„**ï¼Œé€™æ˜¯æ¥­ç•Œæ¨™æº–
- **é–‹ç™¼ç’°å¢ƒï¼šä¸æ˜¯**ï¼Œå¯ä»¥ç”¨è¼ªè©¢è‡¨æ™‚æ›¿ä»£
- **æœ€ä½³å¯¦è¸ï¼šæ··åˆæ–¹æ¡ˆ**ï¼ŒWebhook + è¼ªè©¢å‚™ç”¨

### **å…¶ä»–æ–¹æ³•ï¼Ÿ**
- âœ… **è¼ªè©¢**ï¼šå¯ç”¨ï¼Œä½†æœ‰é™åˆ¶
- âœ… **æ··åˆæ–¹æ¡ˆ**ï¼šæœ€ä½³é¸æ“‡
- âŒ **åƒ…å‰ç«¯**ï¼šä¸å®‰å…¨ï¼Œä¸å¯ç”¨

### **æ¥­ç•Œåšæ³•ï¼Ÿ**
- **95%+ ä½¿ç”¨ Webhook** ä½œç‚ºä¸»è¦æ–¹æ³•
- **å¤§å…¬å¸éƒ½ç”¨æ··åˆæ–¹æ¡ˆ** ç¢ºä¿é›¶éºæ¼
- **Stripe å®˜æ–¹å¼·çƒˆæ¨è–¦** Webhook

**çµè«–ï¼šWebhook ä¸æ˜¯å”¯ä¸€æ–¹æ³•ï¼Œä½†æ˜¯æœ€ä½³æ–¹æ³•ï¼** 