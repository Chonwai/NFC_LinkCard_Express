// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
  engineType      = "binary"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL") // æ™®é€šæ“ä½œç”¨ï¼Œå¯ä»¥ç”¨é€£æ¥æ± 
  directUrl = env("POSTGRES_MIGRATION_URL") // migrationç”¨ï¼Œå¿…é ˆç›´æ¥é€£æ¥
}

model User {
  id                     String              @id @default(uuid())
  username               String              @unique
  email                  String              @unique
  password               String
  display_name           String?             @map("display_name")
  avatar                 String?
  bio                    String?
  is_verified            Boolean             @default(false) @map("is_verified")
  verified_at            DateTime?           @map("verified_at")
  verification_token     String?             @map("verification_token")
  reset_password_token   String?             @map("reset_password_token")
  reset_password_expires DateTime?           @map("reset_password_expires")
  meta                   Json?               @default("{}")
  created_at             DateTime            @default(now()) @map("created_at")
  updated_at             DateTime            @updatedAt @map("updated_at")
  links                  Link[]
  profiles               Profile[]
  analytics              Analytics[]
  associations           Association[] // æ”¹ç‚ºæ”¯æŒå¤šå”æœƒ
  memberOf               AssociationMember[]
  purchaseOrders         PurchaseOrder[]     // æ–°å¢ï¼šç”¨æˆ¶çš„è³¼è²·è¨‚å–®
  associationLeads       AssociationLead[]   // ğŸ†• æ–°å¢ï¼šç”¨æˆ¶ç›¸é—œçš„Leadè¨˜éŒ„
  purchaseIntentData     PurchaseIntentData[] // ğŸ†• æ–°å¢ï¼šç”¨æˆ¶çš„è³¼è²·æ„å‘æ•¸æ“š

  @@map("users")
}

model Profile {
  id                  String         @id @default(uuid())
  name                String
  slug                String         @unique
  user_id             String         @map("user_id")
  user                User           @relation(fields: [user_id], references: [id])
  links               Link[]
  custom_domain       String?        @map("custom_domain")
  is_public           Boolean        @default(true) @map("is_public")
  is_default          Boolean        @default(false) @map("is_default")
  description         String?
  profile_image       String?        @map("profile_image")
  created_at          DateTime       @default(now()) @map("created_at")
  updated_at          DateTime       @updatedAt @map("updated_at")
  meta                Json?          @default("{}")
  appearance          Json?          @default("{}")
  enable_lead_capture Boolean        @default(false) @map("enable_lead_capture")
  lead_capture_fields Json?          @map("lead_capture_fields")
  leads               Lead[]
  badges              ProfileBadge[] // æ·»åŠ å¾½ç« é—œè¯

  @@index([user_id])
  @@map("profiles")
}

model Link {
  id            String        @id @default(uuid())
  title         String
  url           String
  description   String?
  is_active     Boolean       @default(true) @map("is_active")
  click_count   Int           @default(0) @map("click_count")
  icon          String?
  user_id       String        @map("user_id")
  user          User          @relation(fields: [user_id], references: [id])
  display_order Int           @default(0) @map("display_order")
  created_at    DateTime      @default(now()) @map("created_at")
  updated_at    DateTime      @updatedAt @map("updated_at")
  profile_id    String        @map("profile_id")
  profile       Profile       @relation(fields: [profile_id], references: [id])
  meta          Json?         @default("{}")
  type          LinkType      @default(CUSTOM)
  platform      LinkPlatform?
  analytics     Analytics[]

  @@index([user_id])
  @@index([profile_id])
  @@map("links")
}

model Analytics {
  id         String   @id @default(uuid())
  user_id    String   @map("user_id")
  user       User     @relation(fields: [user_id], references: [id])
  link_id    String?  @map("link_id")
  link       Link?    @relation(fields: [link_id], references: [id])
  visitor_ip String   @map("visitor_ip")
  user_agent String?  @map("user_agent")
  referer    String?
  country    String?
  city       String?
  timestamp  DateTime @default(now())
  meta       Json?    @default("{}")

  @@index([user_id])
  @@index([link_id])
  @@map("analytics")
}

model Lead {
  id           String   @id @default(uuid())
  profile_id   String   @map("profile_id")
  profile      Profile  @relation(fields: [profile_id], references: [id])
  first_name   String   @map("first_name")
  last_name    String   @map("last_name")
  email        String
  phone_number String?  @map("phone_number")
  company      String?
  job_title    String?  @map("job_title")
  remark       String?
  created_at   DateTime @default(now()) @map("created_at")
  updated_at   DateTime @updatedAt @map("updated_at")

  @@index([profile_id])
  @@map("leads")
}

enum LinkType {
  CUSTOM
  SOCIAL
}

enum LinkPlatform {
  // Social Platforms
  GITHUB
  FACEBOOK
  INSTAGRAM
  LINKEDIN
  TELEGRAM
  WECHAT
  X
  YOUTUBE
  // Custom Platforms
  WEBSITE
  PHONE
  EMAIL
  LOCATION
}

enum MemberRole {
  ADMIN
  MEMBER
}

enum MembershipTier {
  BASIC
  PREMIUM
  EXECUTIVE
}

enum MembershipStatus {
  ACTIVE // æ´»èºæœƒå“¡
  INACTIVE // éæ´»èºæœƒå“¡
  PENDING // å¾…æ‰¹å‡†
  EXPIRED // æœƒå“¡å·²éæœŸ
  SUSPENDED // æœƒå“¡å·²æš«åœï¼ˆä¾‹å¦‚é•åè¦å®šï¼‰
  TERMINATED // æœƒå“¡å·²çµ‚æ­¢ï¼ˆä¾‹å¦‚ç”±ç®¡ç†å“¡çµ‚æ­¢ï¼‰
  CANCELLED // æœƒå“¡è‡ªè¡Œå–æ¶ˆ
}

model Association {
  id            String  @id @default(uuid())
  name          String
  slug          String  @unique
  description   String?
  logo          String?
  banner        String? // å”æœƒæ©«å¹…åœ–ç‰‡URL
  website       String?
  email         String?
  phone         String?
  address       String?
  socialLinks   Json?   @map("social_links") // å­˜å„²ç¤¾äº¤åª’é«”é€£çµ
  customization Json? // å­˜å„²è‡ªå®šç¾©è¨­ç½®ï¼ˆé¡è‰²ã€å­—é«”ç­‰ï¼‰
  isPublic      Boolean @default(true) @map("is_public")
  badgeImage    String? @map("badge_image") // å”æœƒå¾½ç« åœ–ç‰‡URL

  // é—œè¯
  userId    String                 @map("user_id") // ç§»é™¤ @unique ç´„æŸä»¥æ”¯æŒå¤šå”æœƒ
  user      User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  members   AssociationMember[]
  leads     AssociationLead[]
  analytics AssociationAnalytics[]
  badges    ProfileBadge[] // æ·»åŠ å¾½ç« é—œè¯
  pricingPlans PricingPlan[]        // æ–°å¢ï¼šå”æœƒçš„å®šåƒ¹æ–¹æ¡ˆ
  purchaseOrders PurchaseOrder[]    // æ–°å¢ï¼šå”æœƒçš„è³¼è²·è¨‚å–®
  purchaseIntentData PurchaseIntentData[] // ğŸ†• æ–°å¢ï¼šå”æœƒçš„è³¼è²·æ„å‘æ•¸æ“š

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@map("associations") // Map to snake_case plural
}

model AssociationMember {
  id String @id @default(uuid())

  // å”æœƒé—œè¯
  associationId String      @map("association_id")
  association   Association @relation(fields: [associationId], references: [id], onDelete: Cascade)

  // ç”¨æˆ¶é—œè¯
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  role             MemberRole       @default(MEMBER)
  membershipTier   MembershipTier   @default(BASIC) @map("membership_tier")
  membershipStatus MembershipStatus @default(PENDING) @map("membership_status")

  displayInDirectory Boolean   @default(true) @map("display_in_directory")
  position           String? // åœ¨å”æœƒä¸­çš„è·ä½
  joinDate           DateTime  @default(now()) @map("join_date")
  renewalDate        DateTime? @map("renewal_date") // æœƒå“¡çºŒè²»æ—¥æœŸ
  deleted_at         DateTime? @map("deleted_at") // è»Ÿåˆªé™¤æ™‚é–“æˆ³

  meta Json? @default("{}")

  statusHistory MembershipHistory[] // æœƒå“¡è³‡æ ¼ç‹€æ…‹è®Šæ›´æ­·å²

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([associationId, userId], map: "association_members_association_id_user_id_key") // Explicitly map unique constraint name
  @@index([associationId])
  @@index([userId])
  @@map("association_members") // Map to snake_case plural
}

model AssociationLead {
  id String @id @default(uuid())

  // å”æœƒé—œè¯
  associationId String      @map("association_id")
  association   Association @relation(fields: [associationId], references: [id], onDelete: Cascade)

  // åŸºæœ¬Leadä¿¡æ¯
  firstName    String  @map("first_name")
  lastName     String  @map("last_name")
  email        String
  phone        String?
  organization String?
  message      String?
  status       String  @default("NEW") // NEW, CONTACTED, QUALIFIED, CONVERTED, REJECTED

  // ğŸ†• æ–°å¢å­—æ®µï¼šä¾†æºè¿½è¹¤å’Œå„ªå…ˆç´šç®¡ç†
  source           String?  @default("WEBSITE_CONTACT") // "PURCHASE_INTENT" | "WEBSITE_CONTACT" | "EVENT_REGISTRATION" | "REFERRAL" | "OTHER"
  priority         String?  @default("MEDIUM") // "LOW" | "MEDIUM" | "HIGH" | "URGENT"
  
  // ğŸ†• é—œè¯å­—æ®µ
  purchaseOrderId  String?  @map("purchase_order_id") // é—œè¯çš„è³¼è²·è¨‚å–®
  userId           String?  @map("user_id") // é—œè¯çš„ç”¨æˆ¶ï¼ˆå¦‚æœå·²è¨»å†Šï¼‰
  
  // ğŸ†• æ“´å±•å…ƒæ•¸æ“š - å­˜å„²è³¼è²·ä¸Šä¸‹æ–‡å’Œå…¶ä»–éˆæ´»æ•¸æ“š
  metadata         Json?    // å­˜å„²è³¼è²·ä¸Šä¸‹æ–‡ã€è¡¨å–®ä¾†æºç­‰ä¿¡æ¯

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // ğŸ†• æ–°å¢é—œè¯
  purchaseOrder PurchaseOrder? @relation(fields: [purchaseOrderId], references: [id], onDelete: SetNull)
  user          User?          @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([associationId])
  @@index([email])
  @@index([source]) // ğŸ†• ä¾†æºç´¢å¼•ï¼Œç”¨æ–¼å¿«é€Ÿéæ¿¾
  @@index([priority]) // ğŸ†• å„ªå…ˆç´šç´¢å¼•ï¼Œç”¨æ–¼æ’åº
  @@index([status]) // ğŸ†• ç‹€æ…‹ç´¢å¼•ï¼Œç”¨æ–¼ç‹€æ…‹éæ¿¾
  @@index([purchaseOrderId]) // ğŸ†• è¨‚å–®é—œè¯ç´¢å¼•
  @@index([userId]) // ğŸ†• ç”¨æˆ¶é—œè¯ç´¢å¼•
  @@index([createdAt]) // ğŸ†• å‰µå»ºæ™‚é–“ç´¢å¼•ï¼Œç”¨æ–¼æ™‚é–“ç¯„åœæŸ¥è©¢
  @@map("association_leads") // Map to snake_case plural
}

// ğŸ†• è³¼è²·æ„å‘æ•¸æ“šè¡¨ - å°ˆé–€è™•ç†è³¼è²·æµç¨‹ä¸­çš„ç”¨æˆ¶æ•¸æ“šæ”¶é›†
model PurchaseIntentData {
  id String @id @default(uuid())

  // é—œè¯ä¿¡æ¯
  associationId String      @map("association_id")
  association   Association @relation(fields: [associationId], references: [id], onDelete: Cascade)
  userId        String?     @map("user_id") // å¯èƒ½ç‚ºç©ºï¼ˆè¨»å†Šå‰å¡«å¯«ï¼‰
  user          User?       @relation(fields: [userId], references: [id], onDelete: SetNull)
  purchaseOrderId String?   @map("purchase_order_id") // ä»˜æ¬¾æˆåŠŸå¾Œé—œè¯
  purchaseOrder PurchaseOrder? @relation(fields: [purchaseOrderId], references: [id], onDelete: SetNull)

  // ç”¨æˆ¶å¡«å¯«çš„æ•¸æ“š
  firstName    String  @map("first_name")
  lastName     String  @map("last_name")
  email        String
  phone        String?
  organization String?
  message      String?

  // ç‹€æ…‹ç®¡ç†
  status String @default("PENDING") // PENDING, CONVERTED, EXPIRED

  // è‡ªå‹•åŒ–è¨­ç½®
  autoCreateProfile Boolean @default(true) @map("auto_create_profile")
  profileSettings   Json?   @map("profile_settings") // Profileå‰µå»ºåå¥½è¨­ç½®

  // è³¼è²·ä¸Šä¸‹æ–‡ä¿¡æ¯
  purchaseContext Json? @map("purchase_context") // å­˜å„²å”æœƒã€æ–¹æ¡ˆç­‰è³¼è²·ç›¸é—œä¿¡æ¯

  // æ™‚é–“æˆ³
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  convertedAt DateTime? @map("converted_at") // è½‰åŒ–å®Œæˆæ™‚é–“
  expiresAt   DateTime  @map("expires_at") // æ•¸æ“šéæœŸæ™‚é–“ï¼ˆé»˜èª30å¤©å¾Œï¼‰

  @@index([associationId])
  @@index([userId])
  @@index([email])
  @@index([status])
  @@index([purchaseOrderId])
  @@index([expiresAt]) // ç”¨æ–¼æ¸…ç†éæœŸæ•¸æ“š
  @@index([createdAt]) // ç”¨æ–¼æ™‚é–“ç¯„åœæŸ¥è©¢
  @@map("purchase_intent_data")
}

model AssociationAnalytics {
  id String @id @default(uuid())

  // å”æœƒé—œè¯
  associationId String      @map("association_id")
  association   Association @relation(fields: [associationId], references: [id], onDelete: Cascade)

  eventType String @map("event_type")
  meta      Json?

  createdAt DateTime @default(now()) @map("created_at")

  @@index([associationId])
  @@index([eventType])
  @@index([createdAt])
  @@map("association_analytics") // Map to snake_case plural
}

// å€‹äººæª”æ¡ˆå¾½ç« æ¨¡å‹ - è¡¨ç¤ºåœ¨ç”¨æˆ¶æª”æ¡ˆä¸Šé¡¯ç¤ºçš„å”æœƒå¾½ç« 
model ProfileBadge {
  id String @id @default(uuid())

  // é—œè¯
  profileId     String      @map("profile_id")
  profile       Profile     @relation(fields: [profileId], references: [id], onDelete: Cascade)
  associationId String      @map("association_id")
  association   Association @relation(fields: [associationId], references: [id], onDelete: Cascade)

  // å±¬æ€§
  displayOrder Int              @default(0) @map("display_order") // é¡¯ç¤ºé †åº
  isVisible    Boolean          @default(true) @map("is_visible") // æ˜¯å¦é¡¯ç¤º
  customLabel  String?          @map("custom_label") // è‡ªå®šç¾©æ¨™ç±¤
  customColor  String?          @map("custom_color") // è‡ªå®šç¾©é¡è‰²
  customSize   String?          @map("custom_size") // è‡ªå®šç¾©å¤§å° (å°ã€ä¸­ã€å¤§)
  displayMode  BadgeDisplayMode @default(FULL) @map("display_mode")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([profileId, associationId], map: "profile_badges_profile_id_association_id_key") // Explicitly map unique constraint name
  @@index([profileId])
  @@index([associationId])
  @@map("profile_badges")
}

enum BadgeDisplayMode {
  HIDDEN
  BADGE_ONLY
  FULL
}

// æ–°å¢æœƒå“¡æ­·å²è¨˜éŒ„æ¨¡å‹
model MembershipHistory {
  id                    String            @id @default(uuid())
  association_member_id String            @map("association_member_id")
  associationMember     AssociationMember @relation(fields: [association_member_id], references: [id], onDelete: Cascade)
  previous_status       MembershipStatus  @map("previous_status")
  new_status            MembershipStatus  @map("new_status")
  changed_by            String            @map("changed_by") // ç”¨æˆ¶ID
  reason                String?
  created_at            DateTime          @default(now()) @map("created_at")

  @@index([association_member_id])
  @@map("membership_history")
}

// MVP ä»˜è²»åŠŸèƒ½ï¼šå®šåƒ¹æ–¹æ¡ˆ
model PricingPlan {
  id                   String              @id @default(uuid())
  associationId        String              @map("association_id")
  association          Association         @relation(fields: [associationId], references: [id], onDelete: Cascade)
  
  // æ–¹æ¡ˆåŸºæœ¬ä¿¡æ¯
  name                 String              // æ–¹æ¡ˆåç¨± (å¦‚ "BASIC", "PREMIUM", "EXECUTIVE")
  displayName          String              @map("display_name") // é¡¯ç¤ºåç¨± (å¦‚ "åŸºç¤æœƒå“¡", "é«˜ç´šæœƒå“¡", "åŸ·è¡Œæœƒå“¡")
  description          String?             // æ–¹æ¡ˆæè¿°
  membershipTier       MembershipTier      @map("membership_tier") // å°æ‡‰çš„æœƒå“¡ç­‰ç´š
  
  // åƒ¹æ ¼è¨­å®š
  price                Decimal             @db.Decimal(10, 2) // åƒ¹æ ¼
  currency             String              @default("HKD") // è²¨å¹£
  billingCycle         String              @default("YEARLY") // è¨ˆè²»é€±æœŸ: MONTHLY, YEARLY
  
  // Stripe é›†æˆ
  stripeProductId      String?             @map("stripe_product_id") // Stripe Product ID
  stripePriceId        String?             @map("stripe_price_id") // Stripe Price ID
  
  // ç‹€æ…‹
  isActive             Boolean             @default(true) @map("is_active")
  
  // ç³»çµ±å­—æ®µ
  createdAt            DateTime            @default(now()) @map("created_at")
  updatedAt            DateTime            @updatedAt @map("updated_at")
  
  // é—œè¯
  purchaseOrders       PurchaseOrder[]

  @@unique([associationId, membershipTier])
  @@index([associationId])
  @@index([isActive])
  @@map("pricing_plans")
}

// MVP ä»˜è²»åŠŸèƒ½ï¼šè³¼è²·è¨‚å–®
model PurchaseOrder {
  id                   String              @id @default(uuid())
  
  // é—œè¯
  associationId        String              @map("association_id")
  association          Association         @relation(fields: [associationId], references: [id], onDelete: Cascade)
  userId               String              @map("user_id")
  user                 User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  pricingPlanId        String              @map("pricing_plan_id")
  pricingPlan          PricingPlan         @relation(fields: [pricingPlanId], references: [id], onDelete: Restrict)
  
  // ğŸ†• Leadé—œè¯ - æ”¯æŒè³¼è²·å‰Leadæ”¶é›†
  leadId               String?             @map("lead_id") // é—œè¯çš„Leadï¼ˆå¦‚æœé€šéLeadæµç¨‹è³¼è²·ï¼‰
  
  // è¨‚å–®ä¿¡æ¯
  orderNumber          String              @unique @map("order_number") // è¨‚å–®è™Ÿ
  amount               Decimal             @db.Decimal(10, 2) // é‡‘é¡
  currency             String              @default("HKD") // è²¨å¹£
  status               String              @default("PENDING") // PENDING, PAID, FAILED, REFUNDED
  
  // Stripe é›†æˆæ•¸æ“š (ä½¿ç”¨ JSON å­˜å„²ä»¥ä¿æŒéˆæ´»æ€§)
  stripeData           Json?               @map("stripe_data") // å­˜å„² Stripe ç›¸é—œæ•¸æ“š
  
  // æœƒå“¡æ¬Šç›Šç”Ÿæ•ˆæœŸé–“
  membershipStartDate  DateTime?           @map("membership_start_date")
  membershipEndDate    DateTime?           @map("membership_end_date")
  
  // ç³»çµ±å­—æ®µ
  createdAt            DateTime            @default(now()) @map("created_at")
  updatedAt            DateTime            @updatedAt @map("updated_at")
  paidAt               DateTime?           @map("paid_at") // æ”¯ä»˜å®Œæˆæ™‚é–“

  // ğŸ†• Leadé—œè¯
  leads                AssociationLead[]   // ä¸€å€‹è¨‚å–®å¯èƒ½é—œè¯å¤šå€‹Leadï¼ˆä¸»è¦æ˜¯ä¸€å€‹ï¼Œä½†ä¿æŒéˆæ´»æ€§ï¼‰
  purchaseIntentData   PurchaseIntentData[] // ğŸ†• æ–°å¢ï¼šè¨‚å–®çš„è³¼è²·æ„å‘æ•¸æ“šé—œè¯

  @@index([associationId])
  @@index([userId])
  @@index([status])
  @@index([orderNumber])
  @@index([leadId]) // ğŸ†• Leadé—œè¯ç´¢å¼•
  @@map("purchase_orders")
}
